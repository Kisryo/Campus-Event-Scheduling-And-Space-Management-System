{% extends 'student/base_student.html' %}
{% block title %}Browse Events | MMUEvent{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
{% endblock %}

{% block content %}

<div class="main-content-wrapper">
    
    <div class="mb-4 text-center">
        <h1 class="font-weight-bold">Campus Events</h1>
        <p class="text-muted">Discover what's happening or look back at past activities.</p>
    </div>

    <div class="d-flex justify-content-center mb-5">
        <div class="timeframe-toggle shadow-sm">
            <a href="{{ url_for('student_view.events', timeframe='upcoming', category=current_category, search=search_query, sort=current_sort) }}" 
               class="toggle-btn {{ 'active' if current_timeframe == 'upcoming' else '' }}">
                <i class="fas fa-calendar-check mr-2"></i> Upcoming
            </a>
            
            <a href="{{ url_for('student_view.events', timeframe='past', category=current_category, search=search_query, sort=current_sort) }}" 
               class="toggle-btn {{ 'active' if current_timeframe == 'past' else '' }}">
                <i class="fas fa-history mr-2"></i> Past Events
            </a>
        </div>
    </div>

    <form method="GET" action="{{ url_for('student_view.events') }}" class="mb-5">
        <input type="hidden" name="timeframe" value="{{ current_timeframe }}">
        
        <div class="search-sort-wrapper">
            
            <div class="category-nav">
                <a href="{{ url_for('student_view.events', category='', timeframe=current_timeframe, search=search_query, sort=current_sort) }}" 
                   class="category-btn {{ 'active' if not current_category else '' }}">
                   All
                </a>
                {% for cat in categories_nav %}
                <a href="{{ url_for('student_view.events', category=cat.category_id, timeframe=current_timeframe, search=search_query, sort=current_sort) }}" 
                   class="category-btn {{ 'active' if current_category|int == cat.category_id else '' }}">
                   {{ cat.category_name }}
                </a>
                {% endfor %}
            </div>

            <div class="search-controls">
                <input type="text" name="search" class="custom-input" 
                       placeholder="Search title..." value="{{ search_query }}">

                <select name="sort" class="custom-select" style="max-width: 180px;" onchange="this.form.submit()">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest</option>
                </select>

                <button type="submit" class="search-submit-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        {% if current_category %}
            <input type="hidden" name="category" value="{{ current_category }}">
        {% endif %}
    </form>

    {% if events.items|length == 0 %}
        <div class="no-events-box">
            <h2>No {{ current_timeframe }} events found.</h2>
            <p>Try adjusting your search or category filters.</p>
        </div>
    {% else %}
        <div class="event-grid-container">
            {% for event in events.items %}
            <div class="event-card shadow-sm {{ 'expired-card' if current_timeframe == 'past' else '' }}">
                
                <div class="event-img-wrapper">
                    <img src="{{ url_for('static', filename='images/' ~ (event.event_img if event.event_img else 'default.jpg')) }}" alt="{{ event.title }}">
                    
                    {% if current_timeframe == 'past' %}
                        <div class="completed-badge">COMPLETED</div>
                    {% endif %}
                </div>
                
                <div class="event-details">
                    <h3 class="event-title">{{ event.title }}</h3>
                    <p class="organizer-label"><i class="fas fa-user-circle"></i> {{ event.organizer_id }}</p>
                    
                    <p class="event-date font-weight-bold mb-1 text-dark">
                        <i class="far fa-calendar-alt mr-2 text-success"></i> {{ event.start_datetime.strftime('%d %b %Y, %I:%M %p') }}
                    </p>
                    
                    <p class="event-location font-weight-bold mb-1 text-dark">
                        <i class="fas fa-map-marker-alt"></i> 
                        
                        {# 1. Search for an Approved Booking #}
                        {% set ns = namespace(confirmed_venue=none) %}
                        {% for b in event.bookings %}
                            {% if b.status.status_name == 'Approved' %}
                                {% set ns.confirmed_venue = b.room.room_name %}
                            {% endif %}
                        {% endfor %}

                        {# 2. Display Logic #}
                        {% if ns.confirmed_venue %}
                            <span style="color: #333; font-weight: 600;">{{ ns.confirmed_venue }}</span>
                            
                        {% elif event.venue_location == 'Pending Approval' %}
                            <span style="color: #ffc107; font-weight: 700;">Venue Pending</span>
                            
                        {% else %}
                            {{ event.venue_location if event.venue_location else 'Venue TBD' }}
                        {% endif %}
                    </p>
                    <a href="{{ url_for('student_view.event_details', event_id=event.event_id) }}">
                        <button class="view-details-btn">
                            {{ 'View History' if current_timeframe == 'past' else 'View Details' }}
                        </button>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="pagination">
            {% if events.has_prev %}
                <li><a href="{{ url_for('student_view.events', page=events.prev_num, timeframe=current_timeframe, category=current_category, search=search_query, sort=current_sort) }}">&laquo; Prev</a></li>
            {% endif %}
            
            {% for page_num in events.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if events.page == page_num %}
                        <li class="active"><a href="#">{{ page_num }}</a></li>
                    {% else %}
                        <li><a href="{{ url_for('student_view.events', page=page_num, timeframe=current_timeframe, category=current_category, search=search_query, sort=current_sort) }}">{{ page_num }}</a></li>
                    {% endif %}
                {% else %}
                    <li><span>...</span></li>
                {% endif %}
            {% endfor %}
            
            {% if events.has_next %}
                <li><a href="{{ url_for('student_view.events', page=events.next_num, timeframe=current_timeframe, category=current_category, search=search_query, sort=current_sort) }}">Next &raquo;</a></li>
            {% endif %}
        </div>
    {% endif %}

</div>
{% endblock %}